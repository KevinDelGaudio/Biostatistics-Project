ANALISI DATASET METABRIC


_______ LIBRERIE NECESSARIE PER ESEGUIRE I COMANDI:
```{r}
#install.packages('DAAG')
#install.packages('corrgram')

# LIBRERIE PER CORRELAZIONE
library(DAAG)
library(frailtyEM)
library(corrgram)

# LIBRERIE PER SURVIVAL ANALYSIS
library(survival)
library(ggsurvfit)
library(survminer)

# LIBRERIE PER IL PLOT
library(ggplot2)
library(ggsurvfit)
library(RColorBrewer)
```

_______ CARICARE DATASET

```{r}
cancer <- read.csv("METABRIC_RNA_Mutation.csv", na.strings = c(""))
View(cancer)
```

_______ DATA-CLEANING AND CREATING NEW VARIABLES
 
1) Removing columns not relevant for the analysis
```{r}
# GENI DI INTERESSE: PTEN, CHEK2, CDH1
gene_of_interest <- cancer[,names(cancer) %in% 
                   c('cdh1','gata3','tp53','pik3ca')]
cancer <- cancer[,1:31]
cancer <- cancer[,!names(cancer) %in% 
                   c("cancer_type", "er_status_measured_by_ihc",
                     "her2_status_measured_by_snp6",
                     "mutation_count",
                     "oncotree_code", 'X3.gene_classifier_subtype',
                     "ER.status.measured.by.IHC", "integrative_cluster")]
cancer <- cbind(cancer, gene_of_interest)
```

2) Removing NA values from the dataset
```{r}
# Togliere NA per l'età di diagnosi (se ce ne sono)
cancer <- cancer[!is.na(cancer$age_at_diagnosis),]

# Togliere tutti i tipi d itumore == 'Breast' (dovrebbero esssere 17). Perchè gli togliamo? Perchè non è un tumore specifico
cancer <- cancer[!(cancer$cancer_type_detailed == "Breast"),]
cancer <- cancer[!is.na(cancer$type_of_breast_surgery),]

# Togliere le righe per i pazienti che non hanno informazioni (facendo summary(cancer) non dovrebbero essercene)
filter <- (is.na(cancer$type_of_breast_surgery) &
           is.na(cancer$chemotherapy) & 
           is.na(cancer$hormone_therapy) & 
           is.na(cancer$radio_therapy) &
           is.na(cancer$overall_survival_months))

cancer <- cancer[!filter,]

# Togliere pazienti senza info sulla dimensione del tumore (sono 20)
cancer <- cancer[!is.na(cancer$tumor_size),]

# Togliere i pazienti senza grado del tumore (62 pazieenti)
cancer <- cancer[!is.na(cancer$neoplasm_histologic_grade),]

# Togliere i pazienti senza cellularità
cancer <- cancer[!is.na(cancer$cellularity),]
```


4) Creare la colonna dei sottotipi

```{r}
sub_ty <- function(x) {
  if (x['her2_status'] == 0 & x['er_status'] == 0) 'ER-/HER2-'
  else if (x['her2_status'] == 1 & x['er_status'] == 0) 'ER-/HER2+'
  else if (x['her2_status'] == 0 & x['er_status'] == 1) 'ER+/HER2-'
  else if (x['her2_status'] == 1 & x['er_status'] == 1) 'ER+/HER2+'
  else 'No'
}

cancer$mol_subtypes <- apply(cancer,1,sub_ty)
cancer$mol_subtypes <- as.factor(cancer$mol_subtypes)
```


5) Traformare le colonne dei recettori in colonne binarie (0:NEGATIVO e 1:POSITIVO)
```{r}
cancer$er_status <- ifelse(cancer$er_status == 'Positive',1,0)
cancer$her2_status <- ifelse(cancer$her2_status == 'Positive',1,0)
cancer$pr_status <- ifelse(cancer$pr_status == 'Positive',1,0)
```


6) Column metastasis
```{r}
cancer$metastasis <- ifelse(cancer$gata3 < 0 & cancer$tp53 < 0 & cancer$pik3ca > 1 & cancer$cdh1 < 0, 1, 0)
cancer$metastasis[cancer$garde == 4] <- 1
cancer$metastasis[cancer$lymph_nodes_examined_positive > 10] <- 1
```


6) Tumor grade
```{r}
cancer$stage_size[cancer$tumor_size <= 20] <- 'T1'
cancer$stage_size[cancer$tumor_size > 20 & cancer$tumor_size <= 50] <- 'T2'
cancer$stage_size[cancer$tumor_size > 50] <- 'T3'

cancer$stage_node[cancer$lymph_nodes_examined_positive == 0] <- 'N0'
cancer$stage_node[cancer$lymph_nodes_examined_positive >= 1 & cancer$lymph_nodes_examined_positive <= 3] <- 'N1'
cancer$stage_node[cancer$lymph_nodes_examined_positive > 3 & cancer$lymph_nodes_examined_positive <= 9] <- 'N2'
cancer$stage_node[cancer$lymph_nodes_examined_positive > 9] <- 'N3'


table(cancer$tumor_stage[cancer$stage_size == 'T3' & cancer$stage_node == 'N4'])

cancer$grade <- rep(0, dim(cancer)[1])

cancer$grade[cancer$stage_size == 'T1' & cancer$stage_node == 'N0'] <- 1
cancer$grade[cancer$stage_size == 'T1' & cancer$stage_node == 'N1'] <- 2
cancer$grade[cancer$stage_size == 'T1' & cancer$stage_node == 'N2'] <- 3
cancer$grade[cancer$stage_size == 'T1' & cancer$stage_node == 'N3'] <- 3

cancer$grade[cancer$stage_size == 'T2' & cancer$stage_node == 'N0'] <- 2
cancer$grade[cancer$stage_size == 'T2' & cancer$stage_node == 'N1'] <- 2
cancer$grade[cancer$stage_size == 'T2' & cancer$stage_node == 'N2'] <- 3
cancer$grade[cancer$stage_size == 'T2' & cancer$stage_node == 'N3'] <- 3

cancer$grade[cancer$stage_size == 'T3' & cancer$stage_node == 'N0'] <- 2
cancer$grade[cancer$stage_size == 'T3' & cancer$stage_node == 'N1'] <- 3
cancer$grade[cancer$stage_size == 'T3' & cancer$stage_node == 'N2'] <- 3
cancer$grade[cancer$stage_size == 'T3' & cancer$stage_node == 'N3'] <- 3

              
cancer$grade[cancer$tumor_stage == 4] <- 4
cancer$grade[cancer$metastasis == 1] <- 4
```

```{r}
sub_t <- function(x) {
  if (x['her2_status'] == 'Negative' & (x['er_status'] == 'Positive' | x['pr_status'] == 'Positive') & x['pam50_._claudin.low_subtype'] == 'LumB') 'Luminal B HER2-'
  else if (x['her2_status'] == 'Negative' & (x['er_status'] == 'Positive' | x['pr_status'] == 'Positive') & x['pam50_._claudin.low_subtype'] == 'LumA' | x['pam50_._claudin.low_subtype'] == 'Normal' ) 'Luminal A'
  else if (x['her2_status'] == 'Positive' & x['er_status'] == 'Negative' & x['pr_status'] == 'Negative') 'HER2-enriched'
  else if (x['her2_status'] == 'Positive' & (x['er_status'] == 'Positive' | x['pr_status'] == 'Positive')) 'Luminal B HER2+'
  else if (x['her2_status'] == 'Negative' & x['er_status'] == 'Negative' & x['pr_status'] == 'Negative') 'Triple negative'
  else 'No'
}

cancer$sub_types <- apply(cancer,1,sub_t) 
table(cancer$sub_types)

cancer$sub_types[cancer$sub_types == 'No' & (cancer$pam50_._claudin.low_subtype == 'Basal' | cancer$pam50_._claudin.low_subtype == 'claudin-low')] <- 'Triple negative'
cancer$sub_types[cancer$sub_types == 'No' & (cancer$pam50_._claudin.low_subtype == 'Her2')] <- 'HER2-enriched'
```


Transforming all the variables into FACTORS
```{r}
# La colonna overall_survavial_status è la nostra colonna status, ovvera quella che ci dice se il paziente è ancora vivo (VALORE 1, ovvero censoring o ha finito lo studio) o se i paziente è morto (VALORE 0). Questo passaggio serve per creare correttamente il cox model in modo corretto.
#  `status`: censoring status 1=censored, 2=dead

cancer$overall_survival <- replace(cancer$overall_survival, cancer$death_from_cancer == "Died of Other Causes", 1)
cancer$overall_survival <- as.factor(cancer$overall_survival)

# Comandi per trasformare le variabili in fattori

# VARIABILI TRATTAMENTO
cancer$type_of_breast_surgery <- as.factor(cancer$type_of_breast_surgery)
cancer$chemotherapy <- as.factor(cancer$chemotherapy)
cancer$radio_therapy <- as.factor(cancer$radio_therapy)
cancer$hormone_therapy <- as.factor(cancer$hormone_therapy)
#cancer$therapy_summary <- as.factor(cancer$therapy_summary)

# VARIABILI TIPO DI TUMORE
cancer$cancer_type_detailed <- as.factor(cancer$cancer_type_detailed)
cancer$cellularity <- as.factor(cancer$cellularity)
cancer$inferred_menopausal_state <- as.factor(cancer$inferred_menopausal_state)
cancer$sub_types <- as.factor(cancer$sub_types)
```

_______ DESCRIPTIVE ANALYSIS

1) Distribuzione dell'età
```{r}
summary(cancer$age_at_diagnosis) 
ggplot(cancer, aes(x=cancer$age_at_diagnosis)) + 
  geom_histogram(binwidth=5, fill = "green", color = "darkgreen") +
  labs(x = "Age at Cancer Diagnosis", y = "Frequencies")


age_alive <- cancer$age_at_diagnosis[cancer$overall_survival == 1]
shapiro.test(age_alive) # p-value = 5.272e-07
age_dead <- cancer$age_at_diagnosis[cancer$overall_survival == 0]
shapiro.test(age_dead) # p-value = 0.001477

# CONFRONTARE LE DUE DISTRIBUZIONI CON TEST NON PARAMETRICO (MANN-WHITNEY U TEST)
wilcox.test(age_alive, age_dead, paired=F, alternative='two', exact=F,correct = T)

# Le due distribuzioni sono uguali (p-value = 0.2466)

#GRAFICO:
data <- data.frame(
  type = c(rep("Alive", length(age_alive)), rep("Dead", length(age_dead))),
  value = c(age_alive, age_dead)
)

# Represent it
p <-ggplot(data, aes(x=value, fill=type)) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080")) +
    labs(fill="")
p
```

2) Cancer Sub-Types Divison (how many patients we havee for each subtypes)
```{r}
types <- table(cancer$mol_subtypes)
types <- data.frame(types)
colnames(types) <- c("type", "value")


ggplot(types, aes(x = "", y = value, 
                   fill = type)) +
  geom_col(color = "black") +
  labs(fill = "Type of Breast Cancer") +
  geom_label(aes(label = value),
            color = "Black",
            position = position_stack(vjust = 0.5),
            show.legend = FALSE) +
  coord_polar(theta = "y") +
  scale_fill_brewer(palette = "Green") +
  theme_void()
```

4) BARPLOT OF AGE FOR EACH SUBTYPES
```{r}
table(cancer$neoplasm_histologic_grade[cancer$sub_types == 'claudin-low'])
num <- c(1/288, 33/288, 254/288,     0/117, 15/117, 102/117,      142/1201, 599/1201, 460/1201,       3/94, 28/94, 63/94)
name <- c(rep('ER-/HER2-',3), rep('ER-/HER2+',3), rep('ER+/HER2-',3), rep('ER+/HER2+',3))
grade  <- as.factor(rep(c(1,2,3), 4))

data <- data.frame(name, grade, num)
ggplot(data, aes(fill= grade, y= num, x=name)) + 
    geom_bar(position="dodge", stat="identity") +
    ggtitle("Histologic grades by tumor sub-types") +
    labs(y= "Frequncies", x = "Tumor sub-types") +
    scale_fill_manual(values=c('purple', 'dark blue', 'light blue'))
```


_______ NON PARAMETRIC TESTS

!) Whitney-mann U test to see if there is a different age distribution among tumor sub-types
```{r}
# GRAFICI ETA'

Age_Nothing <- cancer$age_at_diagnosis[cancer$mol_subtypes == 'ER-/HER2-']
shapiro.test(Age_Nothing) #p-value = 7.489e-05, does not follow thee normal distribution
Age_HER2 <- cancer$age_at_diagnosis[cancer$mol_subtypes == 'ER-/HER2+']
shapiro.test(Age_HER2) #p-value = 0.0001012, does not follow thee normal distribution
 Age_ER <- cancer$age_at_diagnosis[cancer$mol_subtypes == 'ER+/HER2-']
shapiro.test(Age_ER) #p-value = 0.5033, follows the normal distribution
Age_HER2.ER <- cancer$age_at_diagnosis[cancer$mol_subtypes == 'ER+/HER2+']
shapiro.test(Age_HER2.PR) #p-value = 0.009004, does not follow the normal distribution



par(mfrow=c(2,4))
hist(Age_Nothing, prob=T, main = 'Age of diagnosis ER-/HER2-',xlab="",breaks = 10, col = "#69b3a2")

hist(Age_HER2, prob=T, main = 'Age of diagnosis ER-/HER2+',xlab="",breaks = 10, col = '#404080')

hist(Age_ER, prob=T, main = 'Age of diagnosis ER+/HER2-',xlab="",breaks = 10, col = "blue")

hist(Age_HER2.ER, prob=T, main = 'Age of diagnosis ER+/HER2+',xlab="",breaks = 10, col = "purple")




boxplot(Age_Nothing,  main = 'Boxplot of Age of diagnosis ER-/HER2-',ylab="", col = "#69b3a2")

boxplot(Age_HER2,  main = 'Boxplot of Age of diagnosis ER-/HER2+',ylab="", col = '#404080')

boxplot(Age_ER,  main = 'Boxplot of Age of diagnosis ER+/HER2-',ylab="", col = "blue")

boxplot(Age_HER2.ER,  main = 'Boxplot of Age of diagnosis ER+/HER2+',ylab="", col = "purple")

```


Resampling approch
```{r}

# Age_Nothing / Age_HER2 / Age_ER / Age_HER2.PR
t <- t.test(Age_ER, Age_HER2.PR, var.equal = T)
TT <- t$statistic

n1 <- length(Age_ER)
n2 <- length(Age_HER2.ER)

set.seed (1)
B <- 10000
Tbs <- rep(NA, B)

for (b in 1:B) {
  
dat<-sample(c(Age_ER, Age_HER2.ER))
Tbs[b]<-t.test(dat[1:n1], dat[(n1 + 1):(n1 + n2)], var.equal = TRUE)$statistic
}

p.value.resample <- mean ((abs(Tbs) >= abs(TT)))
p.value.resample

# Age_Nothing / Age_HER2 <- No difference
# Age_Nothing / Age_ER <- No difference
# Age_Nothing / Age_HER2.ER <- Difference
# Age_HER2 / Age_ER <- No difference
# Age_HER2 / Age_HER2.ER <- No difference
# Age_HER2.PR/ Age_ER <-No difference

# mANCA CORREZZIONE P-VALUES !!
``` 

2) Spearman correlation test and chi-square test between tumor grade and each single subtypes
```{r}
# PRIMO TEST - Vedere la correlazione tra nottingham index e il numero di linfonodi positivi
lumA <- ifelse(cancer$sub_types == 'LumA', 1, 0)
lumB <- ifelse(cancer$sub_types == 'LumB', 1, 0)
HER2 <- ifelse(cancer$sub_types == 'Her2', 1, 0)
Tn <- ifelse(cancer$sub_types == 'Triple negative', 1, 0)

# CHI-SUQARE TEST

# LUMINAL A
contingency_table <- table(lumA, cancer$tumor_stage)
contingency_table
test1 <- chisq.test(contingency_table)
# c'è associazione p-value = 0.0001516
test1.1 <- cor.test(lumA, cancer$tumor_stage, method = 's')
# c'è correlazione negativa p-value = 6.823e-06

# LUMINAL B
contingency_table <- table(lumB, cancer$tumor_stage)
contingency_table
test2 <- chisq.test(contingency_table)
# Non c'è associazione p-value = 0.216
test2.1 <- cor.test(lumB, cancer$tumor_stage, method = 's')
# Non c'è correlazione p-value = 0.05944

# HER2
contingency_table <- table(HER2, cancer$tumor_stage)
contingency_table
test3 <- chisq.test(contingency_table)
# C'è associazione p-value = 0.00287
test3.1 <- cor.test(HER2, cancer$tumor_stage, method = 's')
# C'è una debole (rho = 0.09870116) correlazione p-value = 0.0004457

# Triple Negative
# HER2
contingency_table <- table(Tn, cancer$tumor_stage)
contingency_table
test4 <- chisq.test(contingency_table)
# Non c'è associazione p-value = 0.4416
test4.1 <- cor.test(Tn, cancer$tumor_stage, method = 's')
# Non c'è una correlazione p-value = 0.4926


# Multiple testing correction
p.values_unadj <- c(test1$p.value, test1.1$p.value, test2$p.value, test2.1$p.value, test3$p.value, test3.1$p.value, test4$p.value, test4.1$p.value)
names(p.values_unadj) <- c('LumA CQ', 'LumA S corr.', 'LumB CQ', 'LumB S corr.', 'HER2 CQ', 'HER2 S corr.', 'Tn CQ', 'Tn S corr.')
p.values_unadj
p.values_HM <- p.adjust(p.values_unadj,method = "holm")
p.values_HM

decision_HM <- rep("Do not reject H0",6)
decision_HM[p.values_HM<=0.05] <- "Reject H0"
decision_HM
```


```{r}
# rho  = 0.7345323
# Grafico:
cancer$nottingham_prognostic_index <- round(cancer$nottingham_prognostic_index)
ggboxplot(cancer, x = 'nottingham_prognostic_index', y = 'lymph_nodes_examined_positive')
boxplot(cancer$lymph_nodes_examined_positive ~ cancer$nottingham_prognostic_index)

# SECONDO TEST - Vedere la correlazione tra nottingham index e la dimensione del tumore
cor.test(cancer$tumor_size, cancer$nottingham_prognostic_index, method = 's')

#rho = 0.3055113
# Grafico:
boxplot(cancer$tumor_size ~ cancer$nottingham_prognostic_index)
ggboxplot(cancer, x = 'nottingham_prognostic_index', y = 'tumor_size')
```



```{r}
# SCATTER PLOT DA SISTEMARE
model <- lm(cancer$nottingham_prognostic_index ~ cancer$lymph_nodes_examined_positive)
y <- predict(model, new_data = cancer$lymph_nodes_examined_positive, interval = 'confidence') 

plot(log(cancer$lymph_nodes_examined_positive), cancer$nottingham_prognostic_index)
matlines(exp(cancer$lymph_nodes_examined_positive), y, lwd = 2)
curve(coef(mod.log)[1] + coef(mod.log)[2]*log(cancer$nottingham_prognostic_index), add=TRUE)
```


_______ SURVIAVL ANALYSIS

1) KM curves per posizione del tumore
```{r}
cancer <- cancer[!(cancer$cancer_type_detailed == 'Metaplastic Breast Cancer' | cancer$cancer_type_detailed == 'Breast Invasive Mixed Mucinous Carcinoma'),]

# Utilizziamo la colonna sub_types per dividire a seconda del tipo di tumore presenta
survival <- Surv(cancer$overall_survival_months, cancer$overall_survival == 0)

# Creazione curve per i vari sub-types
sub_types_curves <- survfit(survival ~ cancer_type_detailed, data = cancer)

# Plot delle curve di sopravvivenza
survfit2(survival ~ cancer_type_detailed, data = cancer) |>
  ggsurvfit(linewidth = 1) +
  add_confidence_interval() + # add confidence interval
  add_risktable() + # Add risk table
  add_quantile(y_value = 0.5, color = "gray50", linewidth = 0.75)+  # Specify median survival
  labs(title = "Kaplan-Meier Curve for Subtypes of Breast Cancer Survival",
       x="Follow-up time (months)")+
  scale_x_continuous(breaks = seq(0,1000,by=90))

test <- survdiff(Surv(cancer$overall_survival_months, cancer$overall_survival == 0) ~ cancer_type_detailed,data=cancer)
test
# p= 0.6 NO DIFFERENCE BETWEEN THE CURVES
```

2) KM curves per i vari sottotipi di tumore
```{r}
# Utilizziamo la colonna sub_types per dividire a seconda del tipo di tumore presenta
survival <- Surv(cancer$overall_survival_months, cancer$overall_survival == 0)

# Creazione curve per i vari sub-types
sub_types_curves <- survfit(survival ~ mol_subtypes, data = cancer)

# Plot delle curve di sopravvivenza
survfit2(survival ~ mol_subtypes, data = cancer) |>
  ggsurvfit(linewidth = 1) +
  add_confidence_interval() + # add confidence interval
  add_risktable() + # Add risk table
  add_quantile(y_value = 0.5, color = "gray50", linewidth = 0.75)+  # Specify median survival
  labs(title = "Kaplan-Meier Curve for Subtypes of Breast Cancer Survival",
       x="Follow-up time (months)")+
  scale_x_continuous(breaks = seq(0,1000,by=90))
```

```{r}
# Analizzare tramite long-rank test + BISOGNA FARE I TEST SINGOLI CON HOLM !!!
cancer$NEGATIVE <- ifelse(cancer$sub_types == 'ER-/HER2-', 1, 0)
cancer$HER2 <- ifelse(cancer$sub_types == 'ER-/HER2+', 1, 0)
cancer$ER <- ifelse(cancer$sub_types == 'ER+/HER2-', 1, 0)
cancer$HER2.ER <- ifelse(cancer$sub_types == 'ER+/HER2+', 1, 0)
test <- survdiff(Surv(cancer$overall_survival_months, cancer$overall_survival == 0) ~ sub_types,data=cancer)
test
# The curves are different but among which is different?
# Let's see LumA
test1 <- survdiff(Surv(overall_survival_months, overall_survival == 0) ~ mol_subtypes, data = cancer[cancer$mol_subtypes == 'ER-/HER2-' | cancer$mol_subtypes == 'ER-/HER2+',])
test1

test2 <- survdiff(Surv(overall_survival_months, overall_survival == 0) ~ mol_subtypes, data = cancer[cancer$mol_subtypes == 'ER-/HER2-' | cancer$mol_subtypes == 'ER+/HER2-',])
test2

test3 <- survdiff(Surv(overall_survival_months, overall_survival == 0) ~ mol_subtypes, data = cancer[cancer$mol_subtypes == 'ER-/HER2-' | cancer$mol_subtypes == 'ER+/HER2+',])
test3

# Let's see LumB
test4 <- survdiff(Surv(overall_survival_months, overall_survival == 0) ~ mol_subtypes, data = cancer[cancer$mol_subtypes == 'ER-/HER2+' | cancer$mol_subtypes == 'ER+/HER2-',])
test4

test5 <- survdiff(Surv(overall_survival_months, overall_survival == 0) ~ mol_subtypes, data = cancer[cancer$mol_subtypes == 'ER-/HER2+' | cancer$mol_subtypes == 'ER+/HER2+',])
test5
test5$pvalue

# Last test
test6 <- survdiff(Surv(overall_survival_months, overall_survival == 0) ~ mol_subtypes, data = cancer[cancer$mol_subtypes == 'ER+/HER2-' | cancer$mol_subtypes == 'ER+/HER2+',])
test6
test6$pvalue
# Multiple testing correction

p.values_unadj <- c(test1$pvalue, test2$pvalue, test3$pvalue, test4$pvalue, test5$pvalue, test6$pvalue)
names(p.values_unadj) <- c('ER-/HER2- vs ER-/HER2+', 'ER-/HER2- vs ER+/HER2-', 'ER-/HER2- vs ER+/HER2+', 'ER-/HER2+ vs ER+/HER2-', 'ER-/HER2+ vs ER+/HER2+', 'ER+/HER2- vs ER+/HER2+')
p.values_unadj
p.values_HM <- p.adjust(p.values_unadj, method = "holm")
p.values_HM

decision_HM <- rep("Do not reject H0",6)
decision_HM[p.values_HM<=0.05] <- "Reject H0"
names(decision_HM) <- c('ER-/HER2- vs ER-/HER2+', 'ER-/HER2- vs ER+/HER2-', 'ER-/HER2- vs ER+/HER2+', 'ER-/HER2+ vs ER+/HER2-', 'ER-/HER2+ vs ER+/HER2+', 'ER+/HER2- vs ER+/HER2+')
decision_HM

# LE UNICHE NON DIFFERENTI SONO ER-/HER2- vs ER+/HER2+   E   ER-/HER2+ vs ER+/HER2+, LE ALTRE SONO TUTTE DIFFERENTI
```




3) KM curves per gradi del tumore
```{r}
# Utilizziamo la colonna sub_types per dividire a seconda del tipo di tumore presenta
survival <- Surv(cancer$overall_survival_months, cancer$overall_survival == 0)

# Creazione curve per i vari sub-types
sub_types_curves <- survfit(survival ~ neoplasm_histologic_grade, data = cancer)

# Plot delle curve di sopravvivenza
survfit2(survival ~ neoplasm_histologic_grade, data = cancer) |>
  ggsurvfit(linewidth = 1) +
  add_confidence_interval() + # add confidence interval
  add_risktable() + # Add risk table
  add_quantile(y_value = 0.5, color = "gray50", linewidth = 0.75)+  # Specify median survival
  labs(title = "Kaplan-Meier Curve for Subtypes of Breast Cancer Survival",
       x="Follow-up time (months)")+
  scale_x_continuous(breaks = seq(0,1000,by=90))
```

```{r}
cancer$GRADE1 <- ifelse(cancer$neoplasm_histologic_grade == 1, 1, 0)
cancer$GRADE2 <- ifelse(cancer$neoplasm_histologic_grade == 2, 1, 0)
cancer$GRADE3 <- ifelse(cancer$neoplasm_histologic_grade == 3, 1, 0)

test <- survdiff(Surv(cancer$overall_survival_months, cancer$overall_survival == 0) ~ neoplasm_histologic_grade, data=cancer)
test

# 1 vs 2
test1 <- survdiff(Surv(overall_survival_months, overall_survival == 0) ~ neoplasm_histologic_grade, data = cancer[cancer$neoplasm_histologic_grade == 1 | cancer$neoplasm_histologic_grade == 2,])
test1

# 1 vs 3
test2 <- survdiff(Surv(overall_survival_months, overall_survival == 0) ~ neoplasm_histologic_grade, data = cancer[cancer$neoplasm_histologic_grade == 1 | cancer$neoplasm_histologic_grade == 3,])
test2

# 2 vs 3
test3 <- survdiff(Surv(overall_survival_months, overall_survival == 0) ~ neoplasm_histologic_grade, data = cancer[cancer$neoplasm_histologic_grade == 2 | cancer$neoplasm_histologic_grade == 3,])
test3

p.values_unadj <- c(test1$pvalue, test2$pvalue, test3$pvalue)
names(p.values_unadj) <- c('1 vs 2','1 vs 3','2 vs 3')
p.values_unadj
p.values_HM <- p.adjust(p.values_unadj, method = "holm")
p.values_HM

decision_HM <- rep("Do not reject H0",3)
decision_HM[p.values_HM<=0.05] <- "Reject H0"
names(decision_HM) <- c('1 vs 2','1 vs 3','2 vs 3')
decision_HM

# C'è differenza tra tutte le curve
```

```{r}
# Analizzare tramite long-rank test + BISOGNA FARE I TEST SINGOLI CON HOLM !!!
```



_______ COX MODEL (TIME DEPENDENT COEFF.)

```{r}
vet2 <- survSplit(Surv(overall_survival_months, overall_survival == 0) ~
                    age_at_diagnosis +
                    lymph_nodes_examined_positive + 
                    tumor_size + 
                    er_status +
                    her2_status+ 
                    grade,
                  data = cancer, 
                  cut = c(48, 96, 144), 
                  episode= "tgroup", 
                  id="id")

cox.vet2 <- coxph(Surv(overall_survival_months, event) ~
                   age_at_diagnosis +
                   lymph_nodes_examined_positive  + 
                   er_status:strata(tgroup) + 
                   her2_status +
                   grade:strata(tgroup), 
                  data=vet2)
cox.zph(cox.vet2)
summary(cox.vet2)


```


_______ LOGISTIC REGRESSION

```{r}

cancer$tumor_size <- as.integer(cancer$tumor_size)
cancer$lymph_nodes_examined_positive <- as.integer(cancer$lymph_nodes_examined_positive)

cancer$stage_size <- rep(0, dim(cancer)[1])
cancer$stage_node <- rep(0, dim(cancer)[1])


cancer$metastasis1 <- ifelse(cancer$lymph_nodes_examined_positive > 4, 1, 0)




# MODELLO
mod.glm <- glm(metastasis ~ nottingham_prognostic_index + inferred_menopausal_state + tumor_size + her2_status + er_status + pr_status + tp53 + pik3ca, family=binomial(link=logit), data = cancer)
summary(mod.glm)



# COEFF. MODELLO
coeff_mod <- exp(coef(mod.glm))
coeff_mod



p_threshold = 0.5

Y.hat <- ifelse(mod.glm$fitted.values<p_threshold, 0, 1) 
Y.hat # predicted values

table(Predicted = Y.hat, Observed = cancer$lymph_nodes_examined_positive)

# SENSITIVITY
Sensitivity(y_true = cancer$lymph_nodes_examined_positive, y_pred = Y.hat, positive = 1)
# SPECIFCITY
Specificity(y_true = cancer$lymph_nodes_examined_positive, y_pred = Y.hat, positive = 1)
# ACCURACY
Accuracy(y_pred = Y.hat, y_true = cancer$lymph_nodes_examined_positive)


# ROC CURVE

ROC_curve <- roc(response = cancer$metastasis, predictor = mod.glm$fitted.values,
                 levels = c('0','1'),
                 smooth=FALSE, plot=TRUE, print.auc=TRUE, auc.polygon=TRUE,
                 main="ROC Curve")
ROC_curve

coords(ROC_curve, x="best", transpose = TRUE)
```

We can now compute the performances using 10-folds - VEDERE SE AUC HA UN VALORE SIMILE CON LA CROSS VALIDATION

```{r}
N <- dim(cancer)[1]
N

K = 10
folds <- cut(seq(1,N), breaks=K ,labels=FALSE)#Create K equally size folds (if possible)
set.seed(1234)
folds <- sample(folds)#Randomly shuffle the observations
table(folds)
folds

```

```{r}
sensitivity<-NULL
specificity<-NULL
AUC<-NULL

for(k in 1:10){
  train.data <- cancer[which(folds!=k),]
  test.data <- cancer[which(folds==k),]
  
  mod.glm.k <- glm(lymph_nodes_examined_positive10 ~ , family=binomial(link=logit), data = cancer)
  p.hat.k <- predict(mod.glm.k, newdata = data.frame(test.data), type='response' )
  Y.hat.k <- Y.hat <- ifelse(p.hat.k <p_threshold, 0, 1) 

  sensitivity <- c(sensitivity,
                  Sensitivity(y_true =  test.data$lymph_nodes_examined_positive1, y_pred = Y.hat, positive = 1)
                   )
  specificity <- c(specificity,
                  Specificity(y_true =  test.data$lymph_nodes_examined_positive1, y_pred = Y.hat, positive = 1)
                   )  
  
  AUC <- c(AUC,
           roc(response =  test.data$lymph_nodes_examined_positive1, predictor = Y.hat,
                 levels = c('0','1'),
                 smooth=FALSE, plot=F, print.auc=F)$auc
  )
  
}
```
Vector of performances in terms of sensitivity for the k folds:

```{r}
sensitivity
```

Average sensitivity over the k folds

```{r}
mean(sensitivity)

```

Vector of performances in terms of specificity for the k folds:

```{r}
specificity
```

Average specificity over the k folds

```{r}
mean(specificity)
sd(specificity)
```

Vector of performances in terms of AUC for the k folds

```{r}
AUC
```

Average specificity over the k folds


```{r}
mean(AUC)

```